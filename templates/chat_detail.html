{% extends "layout.html" %} {% block content %} <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script> <style> .md\:hidden.fixed.bottom-0 { display: none !important; } </style> <div class="h-[100dvh] flex flex-col w-full max-w-3xl mx-auto md:border-x md:border-white/10 bg-black relative"> <div class="p-4 border-b border-white/10 flex items-center gap-4 glass bg-black/80 z-20 sticky top-0 backdrop-blur-md"> <a href="/messages" class="text-2xl hover:text-red-500 transition active:scale-90 p-2">←</a> <div class="relative"> {% if other_user.avatar %}<img src="/static/avatars/{{ other_user.avatar }}" class="w-10 h-10 rounded-full object-cover">{% else %}<div class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center font-bold">{{ other_user.username[0] | upper }}</div>{% endif %} <div id="status-dot" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-[#0f0f12] {{ 'bg-green-500' if is_online else 'bg-gray-500' }}"></div> </div> <div> <h2 class="font-bold text-lg leading-none">@{{ other_user.username }}</h2> <span id="typing-indicator" class="text-xs text-green-400 font-bold hidden animate-pulse">yazıyor...</span> </div> </div> <div class="flex-1 overflow-y-auto p-4 space-y-3 flex flex-col scroll-smooth pb-4" id="msgContainer"> {% for msg in messages %} <div class="max-w-[75%] p-3 rounded-2xl text-sm animate__animated animate__fadeInUp {{ 'bg-gradient-to-r from-red-600 to-pink-600 text-white self-end rounded-tr-none' if msg.sender_id == current_user.id else 'bg-gray-800 text-gray-200 self-start rounded-tl-none' }}"> {{ msg.body }} <div class="text-[10px] opacity-70 text-right mt-1">{{ msg.timestamp.strftime('%H:%M') }}</div> </div> {% endfor %} </div> <div class="p-3 border-t border-white/10 glass bg-black z-30 sticky bottom-0 w-full mb-safe"> <div class="flex gap-2 items-center"> <input type="text" id="msgInput" placeholder="Mesaj yaz..." class="flex-1 bg-white/10 rounded-full px-5 py-3 outline-none focus:ring-1 focus:ring-red-500 transition text-white placeholder-gray-500" autocomplete="off"> <button onclick="sendMessage()" class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg shadow-red-600/30 active:scale-90 text-xl">➤</button> </div> </div> </div> <script> const socket = io(); const currentUserId = {{ current_user.id }}; const otherUserId = {{ other_user.id }}; const msgContainer = document.getElementById('msgContainer'); const msgInput = document.getElementById('msgInput'); const typingIndicator = document.getElementById('typing-indicator'); const statusDot = document.getElementById('status-dot'); setTimeout(() => msgContainer.scrollTop = msgContainer.scrollHeight, 100); socket.on('receive_message', function(data) { if (data.sender_id === otherUserId) { appendMessage(data.body, 'received', data.timestamp); typingIndicator.classList.add('hidden'); } }); socket.on('message_sent', function(data) { appendMessage(data.body, 'sent', data.timestamp); }); socket.on('display_typing', function(data) { if (data.sender_id === otherUserId) typingIndicator.classList.remove('hidden'); }); socket.on('hide_typing', function(data) { if (data.sender_id === otherUserId) typingIndicator.classList.add('hidden'); }); socket.on('user_status', function(data) { if (data.user_id === otherUserId) { statusDot.className = `absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-[#0f0f12] ${data.status === 'online' ? 'bg-green-500' : 'bg-gray-500'}`; } }); function sendMessage() { const text = msgInput.value; if (!text) return; socket.emit('send_message', { recipient_id: otherUserId, body: text }); msgInput.value = ''; socket.emit('stop_typing', { recipient_id: otherUserId }); } function appendMessage(text, type, time) { const div = document.createElement('div'); const isSent = type === 'sent'; div.className = `max-w-[75%] p-3 rounded-2xl text-sm animate__animated animate__fadeInUp ${isSent ? 'bg-gradient-to-r from-red-600 to-pink-600 text-white self-end rounded-tr-none' : 'bg-gray-800 text-gray-200 self-start rounded-tl-none'}`; div.innerHTML = `${text}<div class="text-[10px] opacity-70 text-right mt-1">${time}</div>`; msgContainer.appendChild(div); msgContainer.scrollTop = msgContainer.scrollHeight; } let typingTimeout; msgInput.addEventListener('input', () => { socket.emit('typing', { recipient_id: otherUserId }); clearTimeout(typingTimeout); typingTimeout = setTimeout(() => { socket.emit('stop_typing', { recipient_id: otherUserId }); }, 1000); }); msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); }); window.visualViewport.addEventListener('resize', () => { msgContainer.scrollTop = msgContainer.scrollHeight; }); </script> {% endblock %} 