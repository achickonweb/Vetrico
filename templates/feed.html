{% extends "layout.html" %} {% block content %} <div id="reaction-layer" class="fixed inset-0 pointer-events-none z-[100] overflow-hidden"></div> <div class="shorts-wrapper flex flex-col items-center w-full"> {% for video in videos %} <div class="video-section w-full h-full flex justify-center items-center snap-start relative bg-black" data-id="{{ video.id }}"> <div class="relative w-full h-full md:w-[450px] md:h-[calc(100dvh-20px)] md:rounded-[2rem] overflow-hidden bg-black shadow-2xl group flex items-center justify-center"> <div class="absolute inset-0 z-0"><video src="{{ url_for('static', filename='uploads/' + video.filename) }}" class="w-full h-full object-cover blur-2xl opacity-50"></video></div> <video src="{{ url_for('static', filename='uploads/' + video.filename) }}" class="relative z-10 max-w-full max-h-full object-contain cursor-pointer shadow-xl" loop playsinline onclick="togglePlay(this)"></video> <div class="absolute bottom-0 left-0 w-full p-5 pb-24 md:pb-8 z-20 bg-gradient-to-t from-black/90 via-black/50 to-transparent"> <div class="flex items-center gap-3 mb-2"> <a href="{{ url_for('profile', username=video.user.username) }}" class="font-bold flex items-center gap-2 group/user cursor-pointer"> {% if video.user.avatar %}<img src="/static/avatars/{{ video.user.avatar }}" class="w-10 h-10 rounded-full object-cover border-2 border-white/50">{% else %}<div class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center font-bold border-2 border-white/20">{{ video.user.username[0] | upper }}</div>{% endif %} <span class="text-white text-shadow hover:underline text-sm">@{{ video.user.username }}</span> {% if video.user.is_verified %}<span class="verified-badge">âœ“</span>{% endif %} </a> {% if current_user.is_authenticated and current_user.id != video.user_id and not current_user.is_following(video.user) %} <button id="follow-btn-{{ video.user.id }}" onclick="followUser({{ video.user.id }})" class="bg-red-600 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg">Takip Et</button> {% endif %} </div> <p class="text-gray-100 text-sm pl-1 leading-relaxed caption-text mb-2 drop-shadow-md">{{ video.caption }}</p> </div> <div class="absolute bottom-24 right-2 md:bottom-24 md:right-4 flex flex-col gap-4 items-center z-30"> <div class="flex flex-col gap-2 bg-black/40 p-2 rounded-full backdrop-blur-md mb-2"> <button onclick="sendReaction('ğŸ”¥', {{ video.id }})" class="text-2xl hover:scale-125 transition">ğŸ”¥</button> <button onclick="sendReaction('ğŸ˜‚', {{ video.id }})" class="text-2xl hover:scale-125 transition">ğŸ˜‚</button> <button onclick="sendReaction('â¤ï¸', {{ video.id }})" class="text-2xl hover:scale-125 transition">â¤ï¸</button> </div> <div class="flex flex-col items-center"><button onclick="likeVideo({{ video.id }})" class="w-10 h-10 transition active:scale-75"><span id="like-icon-{{ video.id }}" class="text-3xl drop-shadow-lg {{ 'text-red-500' if current_user in video.liked_by else 'text-white' }}">â™¥</span></button><span id="like-count-{{ video.id }}" class="text-xs font-bold drop-shadow-md mt-1">{{ video.liked_by|length }}</span></div> <div class="flex flex-col items-center"><button onclick="openComments({{ video.id }})" class="w-10 h-10 transition active:scale-75 text-3xl text-white drop-shadow-lg">ğŸ’¬</button><span class="text-xs font-bold drop-shadow-md mt-1">{{ video.comments.count() }}</span></div> <button onclick="bookmarkVideo({{ video.id }})" class="w-10 h-10 transition active:scale-75 text-3xl drop-shadow-lg"><span id="bookmark-icon-{{ video.id }}" class="{{ 'text-yellow-400' if video in current_user.bookmarked_videos else 'text-white' }}">ğŸ”–</span></button> <button onclick="reportVideo({{ video.id }})" class="w-8 h-8 bg-black/40 rounded-full flex items-center justify-center text-xs mt-2 text-gray-400 border border-white/10 hover:bg-red-500/50">ğŸš©</button> </div> </div> </div> {% endfor %} </div> <div id="commentModal" class="fixed inset-0 z-modal hidden"> <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeComments()"></div> <div class="absolute bottom-0 w-full md:w-[450px] md:left-1/2 md:-translate-x-1/2 h-[80vh] glass-dark rounded-t-[2rem] flex flex-col transition-transform duration-500 transform translate-y-full border-t border-white/10" id="commentSheet"> <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mt-4 mb-2"></div> <div class="p-4 border-b border-white/5"><h3 class="font-bold text-center text-lg">Yorumlar</h3></div> <div id="commentsList" class="flex-1 overflow-y-auto p-4 space-y-6"></div> <div class="p-4 bg-black/80 backdrop-blur-md pb-8 md:pb-4 border-t border-white/10"> <div id="replyingTo" class="text-xs text-gray-400 mb-2 hidden">YanÄ±t veriliyor... <button onclick="cancelReply()" class="text-white ml-2">Ä°ptal</button></div> <div class="flex gap-2 items-center"> <input type="text" id="commentInput" placeholder="Yorum yap..." class="flex-1 bg-white/10 rounded-full px-5 py-3 outline-none focus:ring-1 focus:ring-red-500 transition text-sm text-white"> <button onclick="postComment()" class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center hover:scale-110 transition text-white">â¤</button> </div> </div> </div> </div> <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script> <script> const socket = io(); let currentVideoId = null; let viewedVideos = new Set(); let replyingToId = null; socket.on('animate_reaction', function(data) { animateEmoji(data.emoji); }); function sendReaction(emoji, vidId) { socket.emit('send_reaction', { emoji: emoji, video_id: vidId }); animateEmoji(emoji); } function animateEmoji(emoji) { const layer = document.getElementById('reaction-layer'); const el = document.createElement('div'); el.innerText = emoji; el.style.position = 'absolute'; el.style.bottom = '100px'; el.style.right = (20 + Math.random() * 50) + 'px'; el.style.fontSize = (30 + Math.random() * 20) + 'px'; el.style.transition = 'all 2s ease-out'; el.style.opacity = '1'; el.style.zIndex = '9999'; layer.appendChild(el); requestAnimationFrame(() => { el.style.transform = `translateY(-${400 + Math.random() * 200}px) rotate(${Math.random() * 90 - 45}deg)`; el.style.opacity = '0'; }); setTimeout(() => { el.remove(); }, 2000); } function togglePlay(v) { v.paused ? v.play() : v.pause(); } const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { const vid = entry.target.querySelector('video.relative'); const vidId = entry.target.getAttribute('data-id'); if (entry.isIntersecting) { vid.play().catch(()=>{}); if (!viewedVideos.has(vidId)) { fetch(`/api/view/${vidId}`, {method: 'POST'}); viewedVideos.add(vidId); } } else { vid.pause(); vid.currentTime = 0; } }); }, {threshold: 0.6}); document.querySelectorAll('.video-section').forEach(s => observer.observe(s)); async function likeVideo(id) { {% if not current_user.is_authenticated %} window.location.href='/login'; return; {% endif %} const res = await fetch(`/api/like/${id}`, {method:'POST'}); const data = await res.json(); document.getElementById(`like-count-${id}`).innerText = data.count; const icon = document.getElementById(`like-icon-${id}`); data.action === 'liked' ? icon.classList.add('text-red-500') : icon.classList.remove('text-red-500'); icon.classList.add('pop-anim'); setTimeout(()=>icon.classList.remove('pop-anim'),300); } async function followUser(uid) { {% if not current_user.is_authenticated %} window.location.href='/login'; return; {% endif %} await fetch(`/api/follow/${uid}`, {method:'POST'}); document.querySelectorAll(`#follow-btn-${uid}`).forEach(b => b.style.display='none'); } async function openComments(vid) { currentVideoId = vid; replyingToId = null; cancelReply(); document.getElementById('mobile-nav').classList.add('hidden-nav'); document.getElementById('commentModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('commentSheet').classList.remove('translate-y-full'),10); loadComments(); } async function loadComments() { const res = await fetch(`/api/comment/${currentVideoId}`); const data = await res.json(); const list = document.getElementById('commentsList'); list.innerHTML = ''; data.forEach(c => { const avatar = c.avatar ? `/static/avatars/${c.avatar}` : ''; const avatarHtml = avatar ? `<img src="${avatar}" class="w-8 h-8 rounded-full object-cover">` : `<div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-xs font-bold">${c.username[0].toUpperCase()}</div>`; const creatorBadge = c.is_video_owner ? '<span class="bg-blue-600 text-[10px] px-1 rounded ml-2">YaratÄ±cÄ±</span>' : ''; const creatorLiked = c.liked_by_creator ? '<div class="text-[10px] text-red-400 mt-1 flex items-center gap-1">â¤ï¸ YaratÄ±cÄ± beÄŸendi</div>' : ''; let repliesHtml = ''; c.replies.forEach(r => { repliesHtml += `<div class="ml-10 mt-2 p-2 bg-white/5 rounded-lg text-sm border-l-2 border-gray-600"> <span class="font-bold text-gray-400 text-xs">@${r.username}</span> ${r.is_video_owner ? '<span class="bg-blue-600 text-[10px] px-1 rounded ml-1">YaratÄ±cÄ±</span>' : ''} <div class="text-white/90">${r.text}</div> </div>`; }); list.innerHTML += `<div class="flex gap-3 animate__animated animate__fadeIn"> ${avatarHtml} <div class="flex-1"> <div class="flex justify-between items-start"> <div class="text-sm"> <span class="font-bold text-gray-300">@${c.username}</span> ${creatorBadge} <div class="text-white mt-0.5">${c.text}</div> ${creatorLiked} <button onclick="setReply(${c.id}, '@${c.username}')" class="text-xs text-gray-500 mt-2 hover:text-white">YanÄ±tla</button> </div> <div class="flex flex-col items-center"> <button onclick="likeComment(${c.id})" class="text-xs ${c.user_liked ? 'text-red-500' : 'text-gray-500'} hover:text-red-500">â¤ï¸</button> <span class="text-[10px] text-gray-500" id="comment-likes-${c.id}">${c.like_count}</span> </div> </div> ${repliesHtml} </div> </div>`; }); } function setReply(id, username) { replyingToId = id; document.getElementById('replyingTo').innerHTML = `YanÄ±tlanÄ±yor: <span class="font-bold">${username}</span> <button onclick="cancelReply()" class="text-red-500 ml-2">X</button>`; document.getElementById('replyingTo').classList.remove('hidden'); document.getElementById('commentInput').focus(); } function cancelReply() { replyingToId = null; document.getElementById('replyingTo').classList.add('hidden'); } async function likeComment(cid) { const res = await fetch(`/api/like_comment/${cid}`, {method:'POST'}); loadComments(); } function closeComments() { document.getElementById('commentSheet').classList.add('translate-y-full'); setTimeout(()=>document.getElementById('commentModal').classList.add('hidden'),500); document.getElementById('mobile-nav').classList.remove('hidden-nav'); } async function postComment() { const txt = document.getElementById('commentInput').value; if(!txt) return; const payload = {text:txt}; if(replyingToId) payload.parent_id = replyingToId; const res = await fetch(`/api/comment/${currentVideoId}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}); const data = await res.json(); if(data.error) { alert(data.error); return; } document.getElementById('commentInput').value=''; cancelReply(); loadComments(); } async function bookmarkVideo(id) { {% if not current_user.is_authenticated %} window.location.href='/login'; return; {% endif %} const res = await fetch(`/api/bookmark/${id}`, {method:'POST'}); const data = await res.json(); const icon = document.getElementById(`bookmark-icon-${id}`); data.action === 'added' ? icon.classList.add('text-yellow-400') : icon.classList.remove('text-yellow-400'); } async function reportVideo(id) { const reason = prompt("Raporlama sebebi:"); if(!reason) return; await fetch(`/api/report/${id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({reason:reason})}); alert("Rapor alÄ±ndÄ±."); } </script> {% endblock %} 